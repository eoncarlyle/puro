import PuroRecord
import toByteBuffer
import java.nio.ByteBuffer
import kotlin.math.ln
import kotlin.math.max
import kotlin.math.sqrt
import kotlin.random.Random

// Adapted from https://github.com/darioradecic/python-1-billion-row-challenge/blob/main/data/createMeasurements.py
class MeasurementFactory(private val stdDev: Double = 10.0) {
    private val rng = Random(1689)

    private fun nextGaussian(mean: Double, std: Double): Double {
        var u: Double
        var v: Double
        var s: Double
        do {
            u = rng.nextDouble() * 2.0 - 1.0
            v = rng.nextDouble() * 2.0 - 1.0
            s = u * u + v * v
        } while (s >= 1.0 || s == 0.0)
        val mul = sqrt(-2.0 * ln(s) / s)
        return mean + std * u * mul
    }

    fun getMeasurements(
        records: Long = 1_000_000L,
    ): ArrayList<PuroRecord> {
        val batchSize = 10_000_000L
        val batches = max(records / batchSize, 1)
        val list = ArrayList<PuroRecord>()

        for (batch in 0 until batches) {
            val from = batch * batchSize
            val to = minOf(from + batchSize, records)
            val count = (to - from).toInt()

            repeat(count) {
                val (name, mean) = stations[rng.nextInt(stations.size)]
                val temp = nextGaussian(mean, stdDev)
                list.add(
                    PuroRecord(
                        "irrelevant topic",
                        rng.nextInt().let { "%016x".format(it) }.toByteBuffer(),
                        ByteBuffer.allocate(4).putInt(rng.nextInt())
                    )
                )
                list.add(PuroRecord("temperatures", name.toByteBuffer(), ByteBuffer.allocate(8).putDouble(temp)))
            }
        }
        return list
    }
}

val stations: List<Pair<String, Double>> = listOf(
    "Abha" to 18.0,
    "Abidjan" to 26.0,
    "Abéché" to 29.4,
    "Accra" to 26.4,
    "Addis Ababa" to 16.0,
    "Adelaide" to 17.3,
    "Aden" to 29.1,
    "Ahvaz" to 25.4,
    "Albuquerque" to 14.0,
    "Alexandra" to 11.0,
    "Alexandria" to 20.0,
    "Algiers" to 18.2,
    "Alice Springs" to 21.0,
    "Almaty" to 10.0,
    "Amsterdam" to 10.2,
    "Anadyr" to -6.9,
    "Anchorage" to 2.8,
    "Andorra la Vella" to 9.8,
    "Ankara" to 12.0,
    "Antananarivo" to 17.9,
    "Antsiranana" to 25.2,
    "Arkhangelsk" to 1.3,
    "Ashgabat" to 17.1,
    "Asmara" to 15.6,
    "Assab" to 30.5,
    "Astana" to 3.5,
    "Athens" to 19.2,
    "Atlanta" to 17.0,
    "Auckland" to 15.2,
    "Austin" to 20.7,
    "Baghdad" to 22.77,
    "Baguio" to 19.5,
    "Baku" to 15.1,
    "Baltimore" to 13.1,
    "Bamako" to 27.8,
    "Bangkok" to 28.6,
    "Bangui" to 26.0,
    "Banjul" to 26.0,
    "Barcelona" to 18.2,
    "Bata" to 25.1,
    "Batumi" to 14.0,
    "Beijing" to 12.9,
    "Beirut" to 20.9,
    "Belgrade" to 12.5,
    "Belize City" to 26.7,
    "Benghazi" to 19.9,
    "Bergen" to 7.7,
    "Berlin" to 10.3,
    "Bilbao" to 14.7,
    "Birao" to 26.5,
    "Bishkek" to 11.3,
    "Bissau" to 27.0,
    "Blantyre" to 22.2,
    "Bloemfontein" to 15.6,
    "Boise" to 11.4,
    "Bordeaux" to 14.2,
    "Bosaso" to 30.0,
    "Boston" to 10.9,
    "Bouaké" to 26.0,
    "Bratislava" to 10.5,
    "Brazzaville" to 25.0,
    "Bridgetown" to 27.0,
    "Brisbane" to 21.4,
    "Brussels" to 10.5,
    "Bucharest" to 10.8,
    "Budapest" to 11.3,
    "Bujumbura" to 23.8,
    "Bulawayo" to 18.9,
    "Burnie" to 13.1,
    "Busan" to 15.0,
    "Cabo San Lucas" to 23.9,
    "Cairns" to 25.0,
    "Cairo" to 21.4,
    "Calgary" to 4.4,
    "Canberra" to 13.1,
    "Cape Town" to 16.2,
    "Changsha" to 17.4,
    "Charlotte" to 16.1,
    "Chiang Mai" to 25.8,
    "Chicago" to 9.8,
    "Chihuahua" to 18.6,
    "Chișinău" to 10.2,
    "Chittagong" to 25.9,
    "Chongqing" to 18.6,
    "Christchurch" to 12.2,
    "City of San Marino" to 11.8,
    "Colombo" to 27.4,
    "Columbus" to 11.7,
    "Conakry" to 26.4,
    "Copenhagen" to 9.1,
    "Cotonou" to 27.2,
    "Cracow" to 9.3,
    "Da Lat" to 17.9,
    "Da Nang" to 25.8,
    "Dakar" to 24.0,
    "Dallas" to 19.0,
    "Damascus" to 17.0,
    "Dampier" to 26.4,
    "Dar es Salaam" to 25.8,
    "Darwin" to 27.6,
    "Denpasar" to 23.7,
    "Denver" to 10.4,
    "Detroit" to 10.0,
    "Dhaka" to 25.9,
    "Dikson" to -11.1,
    "Dili" to 26.6,
    "Djibouti" to 29.9,
    "Dodoma" to 22.7,
    "Dolisie" to 24.0,
    "Douala" to 26.7,
    "Dubai" to 26.9,
    "Dublin" to 9.8,
    "Dunedin" to 11.1,
    "Durban" to 20.6,
    "Dushanbe" to 14.7,
    "Edinburgh" to 9.3,
    "Edmonton" to 4.2,
    "El Paso" to 18.1,
    "Entebbe" to 21.0,
    "Erbil" to 19.5,
    "Erzurum" to 5.1,
    "Fairbanks" to -2.3,
    "Fianarantsoa" to 17.9,
    "Flores,  Petén" to 26.4,
    "Frankfurt" to 10.6,
    "Fresno" to 17.9,
    "Fukuoka" to 17.0,
    "Gabès" to 19.5,
    "Gaborone" to 21.0,
    "Gagnoa" to 26.0,
    "Gangtok" to 15.2,
    "Garissa" to 29.3,
    "Garoua" to 28.3,
    "George Town" to 27.9,
    "Ghanzi" to 21.4,
    "Gjoa Haven" to -14.4,
    "Guadalajara" to 20.9,
    "Guangzhou" to 22.4,
    "Guatemala City" to 20.4,
    "Halifax" to 7.5,
    "Hamburg" to 9.7,
    "Hamilton" to 13.8,
    "Hanga Roa" to 20.5,
    "Hanoi" to 23.6,
    "Harare" to 18.4,
    "Harbin" to 5.0,
    "Hargeisa" to 21.7,
    "Hat Yai" to 27.0,
    "Havana" to 25.2,
    "Helsinki" to 5.9,
    "Heraklion" to 18.9,
    "Hiroshima" to 16.3,
    "Ho Chi Minh City" to 27.4,
    "Hobart" to 12.7,
    "Hong Kong" to 23.3,
    "Honiara" to 26.5,
    "Honolulu" to 25.4,
    "Houston" to 20.8,
    "Ifrane" to 11.4,
    "Indianapolis" to 11.8,
    "Iqaluit" to -9.3,
    "Irkutsk" to 1.0,
    "Istanbul" to 13.9,
    "İzmir" to 17.9,
    "Jacksonville" to 20.3,
    "Jakarta" to 26.7,
    "Jayapura" to 27.0,
    "Jerusalem" to 18.3,
    "Johannesburg" to 15.5,
    "Jos" to 22.8,
    "Juba" to 27.8,
    "Kabul" to 12.1,
    "Kampala" to 20.0,
    "Kandi" to 27.7,
    "Kankan" to 26.5,
    "Kano" to 26.4,
    "Kansas City" to 12.5,
    "Karachi" to 26.0,
    "Karonga" to 24.4,
    "Kathmandu" to 18.3,
    "Khartoum" to 29.9,
    "Kingston" to 27.4,
    "Kinshasa" to 25.3,
    "Kolkata" to 26.7,
    "Kuala Lumpur" to 27.3,
    "Kumasi" to 26.0,
    "Kunming" to 15.7,
    "Kuopio" to 3.4,
    "Kuwait City" to 25.7,
    "Kyiv" to 8.4,
    "Kyoto" to 15.8,
    "La Ceiba" to 26.2,
    "La Paz" to 23.7,
    "Lagos" to 26.8,
    "Lahore" to 24.3,
    "Lake Havasu City" to 23.7,
    "Lake Tekapo" to 8.7,
    "Las Palmas de Gran Canaria" to 21.2,
    "Las Vegas" to 20.3,
    "Launceston" to 13.1,
    "Lhasa" to 7.6,
    "Libreville" to 25.9,
    "Lisbon" to 17.5,
    "Livingstone" to 21.8,
    "Ljubljana" to 10.9,
    "Lodwar" to 29.3,
    "Lomé" to 26.9,
    "London" to 11.3,
    "Los Angeles" to 18.6,
    "Louisville" to 13.9,
    "Luanda" to 25.8,
    "Lubumbashi" to 20.8,
    "Lusaka" to 19.9,
    "Luxembourg City" to 9.3,
    "Lviv" to 7.8,
    "Lyon" to 12.5,
    "Madrid" to 15.0,
    "Mahajanga" to 26.3,
    "Makassar" to 26.7,
    "Makurdi" to 26.0,
    "Malabo" to 26.3,
    "Malé" to 28.0,
    "Managua" to 27.3,
    "Manama" to 26.5,
    "Mandalay" to 28.0,
    "Mango" to 28.1,
    "Manila" to 28.4,
    "Maputo" to 22.8,
    "Marrakesh" to 19.6,
    "Marseille" to 15.8,
    "Maun" to 22.4,
    "Medan" to 26.5,
    "Mek'ele" to 22.7,
    "Melbourne" to 15.1,
    "Memphis" to 17.2,
    "Mexicali" to 23.1,
    "Mexico City" to 17.5,
    "Miami" to 24.9,
    "Milan" to 13.0,
    "Milwaukee" to 8.9,
    "Minneapolis" to 7.8,
    "Minsk" to 6.7,
    "Mogadishu" to 27.1,
    "Mombasa" to 26.3,
    "Monaco" to 16.4,
    "Moncton" to 6.1,
    "Monterrey" to 22.3,
    "Montreal" to 6.8,
    "Moscow" to 5.8,
    "Mumbai" to 27.1,
    "Murmansk" to 0.6,
    "Muscat" to 28.0,
    "Mzuzu" to 17.7,
    "N'Djamena" to 28.3,
    "Naha" to 23.1,
    "Nairobi" to 17.8,
    "Nakhon Ratchasima" to 27.3,
    "Napier" to 14.6,
    "Napoli" to 15.9,
    "Nashville" to 15.4,
    "Nassau" to 24.6,
    "Ndola" to 20.3,
    "New Delhi" to 25.0,
    "New Orleans" to 20.7,
    "New York City" to 12.9,
    "Ngaoundéré" to 22.0,
    "Niamey" to 29.3,
    "Nicosia" to 19.7,
    "Niigata" to 13.9,
    "Nouadhibou" to 21.3,
    "Nouakchott" to 25.7,
    "Novosibirsk" to 1.7,
    "Nuuk" to -1.4,
    "Odesa" to 10.7,
    "Odienné" to 26.0,
    "Oklahoma City" to 15.9,
    "Omaha" to 10.6,
    "Oranjestad" to 28.1,
    "Oslo" to 5.7,
    "Ottawa" to 6.6,
    "Ouagadougou" to 28.3,
    "Ouahigouya" to 28.6,
    "Ouarzazate" to 18.9,
    "Oulu" to 2.7,
    "Palembang" to 27.3,
    "Palermo" to 18.5,
    "Palm Springs" to 24.5,
    "Palmerston North" to 13.2,
    "Panama City" to 28.0,
    "Parakou" to 26.8,
    "Paris" to 12.3,
    "Perth" to 18.7,
    "Petropavlovsk-Kamchatsky" to 1.9,
    "Philadelphia" to 13.2,
    "Phnom Penh" to 28.3,
    "Phoenix" to 23.9,
    "Pittsburgh" to 10.8,
    "Podgorica" to 15.3,
    "Pointe-Noire" to 26.1,
    "Pontianak" to 27.7,
    "Port Moresby" to 26.9,
    "Port Sudan" to 28.4,
    "Port Vila" to 24.3,
    "Port-Gentil" to 26.0,
    "Portland (OR)" to 12.4,
    "Porto" to 15.7,
    "Prague" to 8.4,
    "Praia" to 24.4,
    "Pretoria" to 18.2,
    "Pyongyang" to 10.8,
    "Rabat" to 17.2,
    "Rangpur" to 24.4,
    "Reggane" to 28.3,
    "Reykjavík" to 4.3,
    "Riga" to 6.2,
    "Riyadh" to 26.0,
    "Rome" to 15.2,
    "Roseau" to 26.2,
    "Rostov-on-Don" to 9.9,
    "Sacramento" to 16.3,
    "Saint Petersburg" to 5.8,
    "Saint-Pierre" to 5.7,
    "Salt Lake City" to 11.6,
    "San Antonio" to 20.8,
    "San Diego" to 17.8,
    "San Francisco" to 14.6,
    "San Jose" to 16.4,
    "San José" to 22.6,
    "San Juan" to 27.2,
    "San Salvador" to 23.1,
    "Sana'a" to 20.0,
    "Santo Domingo" to 25.9,
    "Sapporo" to 8.9,
    "Sarajevo" to 10.1,
    "Saskatoon" to 3.3,
    "Seattle" to 11.3,
    "Ségou" to 28.0,
    "Seoul" to 12.5,
    "Seville" to 19.2,
    "Shanghai" to 16.7,
    "Singapore" to 27.0,
    "Skopje" to 12.4,
    "Sochi" to 14.2,
    "Sofia" to 10.6,
    "Sokoto" to 28.0,
    "Split" to 16.1,
    "St. John's" to 5.0,
    "St. Louis" to 13.9,
    "Stockholm" to 6.6,
    "Surabaya" to 27.1,
    "Suva" to 25.6,
    "Suwałki" to 7.2,
    "Sydney" to 17.7,
    "Tabora" to 23.0,
    "Tabriz" to 12.6,
    "Taipei" to 23.0,
    "Tallinn" to 6.4,
    "Tamale" to 27.9,
    "Tamanrasset" to 21.7,
    "Tampa" to 22.9,
    "Tashkent" to 14.8,
    "Tauranga" to 14.8,
    "Tbilisi" to 12.9,
    "Tegucigalpa" to 21.7,
    "Tehran" to 17.0,
    "Tel Aviv" to 20.0,
    "Thessaloniki" to 16.0,
    "Thiès" to 24.0,
    "Tijuana" to 17.8,
    "Timbuktu" to 28.0,
    "Tirana" to 15.2,
    "Toamasina" to 23.4,
    "Tokyo" to 15.4,
    "Toliara" to 24.1,
    "Toluca" to 12.4,
    "Toronto" to 9.4,
    "Tripoli" to 20.0,
    "Tromsø" to 2.9,
    "Tucson" to 20.9,
    "Tunis" to 18.4,
    "Ulaanbaatar" to -0.4,
    "Upington" to 20.4,
    "Ürümqi" to 7.4,
    "Vaduz" to 10.1,
    "Valencia" to 18.3,
    "Valletta" to 18.8,
    "Vancouver" to 10.4,
    "Veracruz" to 25.4,
    "Vienna" to 10.4,
    "Vientiane" to 25.9,
    "Villahermosa" to 27.1,
    "Vilnius" to 6.0,
    "Virginia Beach" to 15.8,
    "Vladivostok" to 4.9,
    "Warsaw" to 8.5,
    "Washington, D.C." to 14.6,
    "Wau" to 27.8,
    "Wellington" to 12.9,
    "Whitehorse" to -0.1,
    "Wichita" to 13.9,
    "Willemstad" to 28.0,
    "Winnipeg" to 3.0,
    "Wrocław" to 9.6,
    "Xi'an" to 14.1,
    "Yakutsk" to -8.8,
    "Yangon" to 27.5,
    "Yaoundé" to 23.8,
    "Yellowknife" to -4.3,
    "Yerevan" to 12.4,
    "Yinchuan" to 9.0,
    "Zagreb" to 10.7,
    "Zanzibar City" to 26.0,
    "Zürich" to 9.3,
)
